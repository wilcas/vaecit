---
title: "PCA vs MMD VAE 2"
author: "William Casazza"
date: "March 10, 2019"
output: github_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(scales)
options(warn=-1)
knitr::opts_chunk$set(echo = TRUE)
```

# Testing Dimensionality Reduction in Causal Inference (SECOND ANALYSIS)

## PCA in Place of Genotype
Step 1: Load in Data
```{r Load PCA Data}
dir()
pca_test_list <- list()
for(f in dir("../data/csvs")){
  model <- gsub("cit_(.*)_([0-9])_PCs.*.csv","\\1", f)
  num_pc <- as.numeric(gsub("cit_(.*)_([0-9])_PCs.*.csv","\\2", f))
  tmp <- read.csv(sprintf("../data/csvs/%s", f))
  tmp$model <- model
  tmp$num_pc <- num_pc
  pca_test_list[[f]] <- tmp
}
tail(pca_df <- bind_rows(pca_test_list))
```
Step 2 is pulling apart the data and plotting
### Differences in performance using different numbers of PCs
```{r Plot PCA P Values, warning=FALSE}
pca_df <- rbind_list(pca_test_list)
pca_df <- pca_df %>% mutate(Model = plyr::mapvalues(model,from = c("caus1","ind1","null"), to = c("Full Mediation", "Independent Association", "Null"))) %>% rename(nPC = num_pc)
```

### Interesting Notes
<!-- Caus1 Appears to work better in the way we constructed the data, but it's important to note that it's about a 50 50 shot to call independent association, as constructed, as causal mediation. In the case where there's no association between variables we don't call causal mediation at all, which is a good behavior. -->


## MMD VAE

Step 1: Load in the data

```{r Load MMD VAE Data}
mmd_test_list <- list()
for(f in dir("../data/mmd_vae_tests_4/")){
  model <- gsub("cit_(.*)_mmdvae_([0-9]*)_depth_([0-9]*)_latent.*.csv","\\1", f)
  num_hidden <- as.numeric(gsub("cit_(.*)_mmdvae_([0-9]*)_depth_([0-9]*)_latent.*.csv","\\2", f))
  num_latent <- as.numeric(gsub("cit_(.*)_mmdvae_([0-9]*)_depth_([0-9]*)_latent.*.csv","\\3", f))
  tmp <- read.csv(sprintf("../data/mmd_vae_tests_4/%s", f))
  tmp$model <- model
  tmp$num_hidden <- num_hidden
  tmp$num_latent <- num_latent
  mmd_test_list[[f]] <- tmp
}
tail(mmd_df <- rbind_list(mmd_test_list))
```

Step 2 is pulling apart the data and plotting
### Differences in performance using different numbers of latent variables and hidden layers
```{r Plot MMD VAE P Values, warning=FALSE}

mmd_df <- rbind_list(mmd_test_list)
mmd_df <- mmd_df %>%  mutate(Model = plyr::mapvalues(model,from = c("caus1","ind1","null"), to = c("Full Mediation", "Independent Association", "Null"))) %>%rename(nLatent = num_latent, nHidden = num_hidden)
```



## VanBUG Draft plots
```{r pca VanBUG}
# condition 1 capture association
ggplot(pca_df, aes(p1, fill = Model)) + geom_histogram(position = "identity", alpha = 0.6) + scale_fill_manual(values = c("blue", "red", "gold")) + labs(y = "Count (100 simulations per model)",x = "P Value") + ggtitle("Directed Association Using Genotype PC 1")+ theme_minimal(base_family = "Arial")+ scale_y_continuous(limits=c(0,100))
ggplot(pca_df, aes(p2, fill = Model)) + geom_histogram(position = "identity", alpha = 0.6) + scale_fill_manual(values = c("blue", "red", "gold")) + labs(y = "Count (100 simulations per model)",x = "P Value") + ggtitle("Association PC 1 with Epigenetics Given Expression")+ theme_minimal(base_family = "Arial")+ scale_y_continuous(limits=c(0,100))
ggplot(pca_df, aes(p3 , fill = Model)) + geom_histogram(position = "identity", alpha = 0.6) + scale_fill_manual(values = c("blue", "red", "gold"))+ labs(y = "Count (100 simulations per model)",x = "P Value ") + ggtitle("Association of Expression with Epigenetic Variable Given Genotype PC1")+ theme_minimal(base_family = "Arial") + scale_y_continuous(limits=c(0,100))
ggplot(pca_df, aes(p4 , fill = Model)) + geom_histogram(position = "identity", alpha = 0.6) + scale_fill_manual(values = c("blue", "red", "gold"))+ labs(y = "Count (100 simulations per model)",x = "P Value") + ggtitle("Independence of Genotype PC1 and Expression Given Epigenetic Variable")+ theme_minimal(base_family = "Arial") + scale_y_continuous(limits=c(0,100))
ggplot(pca_df, aes(omni_p , fill = Model)) + geom_histogram(position = "identity", alpha = 0.6) + scale_fill_manual(values = c("blue", "red", "gold"))+ labs(y = "Count (100 simulations per model)",x = "P Value Epigenetic Mediation") + ggtitle("Capturing Epigenetic Mediation of Genotype PC1")+ theme_minimal(base_family = "Arial") + scale_y_continuous(limits=c(0,100))
```
```{r pca debugging}
to_plot_pca <- pca_df %>% gather(key = "test", value = "test_pvalue",p1,p2,p3,p4,omni_p)
ggplot(to_plot_pca, aes(test_pvalue, fill = Model)) + 
  geom_histogram(position = "identity", alpha = 0.6) + 
  scale_fill_manual(values = c("blue", "red", "gold")) +
  labs(y = "Count (100 simulations per model)",x = "P Value Epigenetic Mediation") +
  ggtitle("Capturing Epigenetic Mediation of Genotype PC1")+ 
  theme_minimal(base_family = "Arial") + 
  scale_y_continuous(limits=c(0,100)) + 
  facet_wrap(~test,ncol=2)
```


```{r mmdvae VanBUG}

ggplot(mmd_df, aes(p1, fill = Model)) + geom_histogram(position = "identity", alpha = 0.6) + scale_fill_manual(values = c("blue", "red", "gold")) + labs(y = "Count (100 simulations per model)",x = "P Value") + ggtitle("Directed Association 1 Autoencoder LV with Expression")+ theme_minimal(base_family = "Arial")+ scale_y_continuous(limits=c(0,100))
ggplot(mmd_df, aes(p2, fill = Model)) + geom_histogram(position = "identity", alpha = 0.6) + scale_fill_manual(values = c("blue", "red", "gold")) + labs(y = "Count (100 simulations per model)",x = "P Value ") + ggtitle("Association 1 Autoencoder LV with Epigenetic Given Expression")+ theme_minimal(base_family = "Arial")+ scale_y_continuous(limits=c(0,100))
ggplot(mmd_df, aes(p3, fill = Model)) + geom_histogram(position = "identity", alpha = 0.6) + scale_fill_manual(values = c("blue", "red", "gold")) + labs(y = "Count (100 simulations per model)",x = "P Value ") + ggtitle("Association of Epigenetic with Expression Given 1 Autoencoder LV")+ theme_minimal(base_family = "Arial")+ scale_y_continuous(limits=c(0,100))
ggplot(mmd_df, aes(p4, fill = Model)) + geom_histogram(position = "identity", alpha = 0.6) + scale_fill_manual(values = c("blue", "red", "gold")) + labs(y = "Count (100 simulations per model)",x = "P Value ") + ggtitle("Independence of 1 Autoencoder LV and Expression Given Epigenetic")+ theme_minimal(base_family = "Arial")+ scale_y_continuous(limits=c(0,100))
ggplot(mmd_df, aes(omni_p , fill = Model)) + geom_histogram(position = "identity", alpha = 0.6) + scale_fill_manual(values = c("blue", "red", "gold")) + labs(y = "Count (100 simulations per model)",x = "P Value Epigenetic Mediation") + ggtitle("Capturing Epigenetic Mediation of 1 Autoencoder LV")+ theme_minimal(base_family = "Arial")+ scale_y_continuous(limits=c(0,100))
```
```{r mmd vae debug}
to_plot_mmd <- mmd_df %>% gather(key = "test", value = "test_pvalue",p1,p2,p3,p4,omni_p)
ggplot(to_plot_mmd, aes(test_pvalue, fill = Model)) + 
  geom_histogram(position = "identity", alpha = 0.6) + 
  scale_fill_manual(values = c("blue", "red", "gold")) +
  labs(y = "Count (100 simulations per model)",x = "P Value Epigenetic Mediation") +
  ggtitle("Capturing Epigenetic Mediation of Genotype PC1")+ 
  theme_minimal(base_family = "Arial") + 
  scale_y_continuous(limits=c(0,100)) + 
  facet_wrap(~test,ncol=2)
```

```{r distribution max 4 uniform RV}
unif_tests <- matrix(runif(4000),1000,4)
ggplot(data.frame(P = apply(unif_tests,1,max)), aes(x = P)) + geom_histogram(fill="gold", alpha = 0.8)+theme_minimal()
```

